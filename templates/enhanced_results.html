<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Results - Yu-Gi-Oh! Arbitrage Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-listing {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-listing:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .score-badge {
            font-size: 0.9rem;
            font-weight: bold;
        }
        .action-strong-buy {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        .action-buy {
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
        }
        .action-consider {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }
        .action-pass {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        .profit-positive {
            color: #28a745;
            font-weight: bold;
        }
        .profit-negative {
            color: #dc3545;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .enhanced-stats {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .card-image-container {
            position: relative;
            height: 200px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #eee;
        }
        .card-image {
            max-height: 180px;
            max-width: 100%;
            object-fit: contain;
        }
        .no-image-placeholder {
            text-align: center;
            color: #6c757d;
        }
        .smart-score {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .risk-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
        }
        .risk-low { background-color: #28a745; color: white; }
        .risk-medium { background-color: #ffc107; color: black; }
        .risk-high { background-color: #dc3545; color: white; }
        .trend-rising { color: #28a745; }
        .trend-falling { color: #dc3545; }
        .trend-stable { color: #6c757d; }
        .enhanced-info {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-dragon me-2"></i>Enhanced Yu-Gi-Oh! Arbitrage Bot
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-chart-line me-1"></i>Dashboard</a>
                <a class="nav-link" href="/search"><i class="fas fa-search me-1"></i>Search</a>
                <a class="nav-link active" href="/results"><i class="fas fa-list me-1"></i>Results</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Enhanced Statistics -->
        <div class="row" id="enhanced-stats-section">
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h4 id="total-listings">0</h4>
                    <p>Total Listings</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h4 id="profitable-listings">0</h4>
                    <p>Profitable</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h4 id="strong-buys">0</h4>
                    <p>Strong Buys</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="enhanced-stats text-center">
                    <h4 id="avg-smart-score">0</h4>
                    <p>Avg Smart Score</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Filters -->
        <div class="filter-section">
            <h5><i class="fas fa-filter me-2"></i>Enhanced Filters</h5>
            <div class="row">
                <div class="col-md-2">
                    <label for="minScore" class="form-label">Min Smart Score:</label>
                    <input type="number" class="form-control" id="minScore" value="0" min="0" max="100">
                </div>
                <div class="col-md-2">
                    <label for="maxPrice" class="form-label">Max Price ($):</label>
                    <input type="number" class="form-control" id="maxPrice" placeholder="No limit">
                </div>
                <div class="col-md-2">
                    <label for="minProfit" class="form-label">Min Profit (%):</label>
                    <input type="number" class="form-control" id="minProfit" value="0">
                </div>
                <div class="col-md-2">
                    <label for="actionFilter" class="form-label">Action:</label>
                    <select class="form-select" id="actionFilter">
                        <option value="">All Actions</option>
                        <option value="STRONG BUY">Strong Buy</option>
                        <option value="BUY">Buy</option>
                        <option value="CONSIDER">Consider</option>
                        <option value="PASS">Pass</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="conditionFilter" class="form-label">Condition:</label>
                    <select class="form-select" id="conditionFilter">
                        <option value="">All Conditions</option>
                        <option value="Mint">Mint</option>
                        <option value="Near Mint">Near Mint</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Light Played">Light Played</option>
                        <option value="Played">Played</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="riskFilter" class="form-label">Risk Level:</label>
                    <select class="form-select" id="riskFilter">
                        <option value="">All Risks</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-2">
                    <label for="searchTermFilter" class="form-label">Search Term:</label>
                    <select class="form-select" id="searchTermFilter">
                        <option value="">All Terms</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="rarityFilter" class="form-label">Rarity:</label>
                    <select class="form-select" id="rarityFilter">
                        <option value="">All Rarities</option>
                        <option value="Common">Common</option>
                        <option value="Uncommon">Uncommon</option>
                        <option value="Rare">Rare</option>
                        <option value="Super Rare">Super Rare</option>
                        <option value="Ultra Rare">Ultra Rare</option>
                        <option value="Secret Rare">Secret Rare</option>
                        <option value="Ghost Rare">Ghost Rare</option>
                        <option value="Prismatic Secret Rare">Prismatic Secret Rare</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="fas fa-search me-1"></i>Apply Filters
                    </button>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results-container">
            <div class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-3">Loading enhanced results...</h4>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentResults = [];
        
        function loadResults() {
            const minScore = document.getElementById('minScore').value;
            const maxPrice = document.getElementById('maxPrice').value;
            const minProfit = document.getElementById('minProfit').value;
            const actionFilter = document.getElementById('actionFilter').value;
            const searchTerm = document.getElementById('searchTermFilter').value;
            const conditionFilter = document.getElementById('conditionFilter').value;
            const rarityFilter = document.getElementById('rarityFilter').value;
            const riskFilter = document.getElementById('riskFilter').value;
            
            const params = new URLSearchParams({
                min_score: minScore,
                min_profit: minProfit
            });
            
            if (maxPrice) params.append('max_price', maxPrice);
            if (actionFilter) params.append('action_filter', actionFilter);
            if (searchTerm) params.append('search_term', searchTerm);
            if (conditionFilter) params.append('condition_filter', conditionFilter);
            if (rarityFilter) params.append('rarity_filter', rarityFilter);
            if (riskFilter) params.append('risk_level', riskFilter);
            
            fetch(`/api/results?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentResults = data.results;
                        displayResults(data.results);
                        updateStats();
                    } else {
                        document.getElementById('results-container').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ${data.message}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    document.getElementById('results-container').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error: ${error.message}
                        </div>
                    `;
                });
        }
        
        function displayResults(results) {
            const container = document.getElementById('results-container');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <h4>No results found</h4>
                        <p>Try adjusting your filters or search for different cards.</p>
                    </div>
                `;
                return;
            }
            
            let html = `<div class="row">`;
            
            results.forEach(result => {
                const profitClass = result.profit_margin >= 0 ? 'profit-positive' : 'profit-negative';
                const actionClass = `action-${result.recommended_action.toLowerCase().replace(' ', '-')}`;
                const detailUrl = `/result/${result.id}`;
                const smartScore = result.smart_score || result.arbitrage_score || 0;
                const enhancedAnalysis = result.enhanced_analysis || {};
                const marketAnalysis = result.market_analysis || {};
                const pricePrediction = result.price_prediction || {};
                
                // Image display with fallback
                const imageHtml = result.image_url ? 
                    `<img src="${result.image_url}" alt="Card Thumbnail" class="card-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" loading="lazy">` : '';
                
                const noImageHtml = `<div class="no-image-placeholder">
                    <i class="fas fa-image fa-2x"></i>
                    <p class="mt-2">No Image</p>
                </div>`;
                
                html += `
                    <div class="col-md-6 col-lg-4">
                        <a href="${detailUrl}" style="text-decoration: none; color: inherit;">
                        <div class="card card-listing">
                            <div class="card-image-container">
                                ${imageHtml}
                                ${noImageHtml}
                                <div class="smart-score">${smartScore.toFixed(1)}</div>
                            </div>
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span class="badge score-badge ${actionClass}">
                                    ${result.recommended_action}
                                </span>
                                <span class="badge risk-badge risk-${marketAnalysis.risk_level?.toLowerCase() || 'medium'}">
                                    ${marketAnalysis.risk_level || 'Unknown'} Risk
                                </span>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title">${result.title}</h6>
                                <p class="card-text text-muted small">
                                    <i class="fas fa-tag me-1"></i>${result.search_term}
                                </p>
                                
                                <!-- Enhanced Analysis Info -->
                                <div class="enhanced-info">
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Condition:</small><br>
                                            <strong>${enhancedAnalysis.condition || 'Unknown'}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Rarity:</small><br>
                                            <strong>${enhancedAnalysis.rarity || 'Unknown'}</strong>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <small class="text-muted">Authenticity:</small><br>
                                            <strong>${((enhancedAnalysis.authenticity_score || 0) * 100).toFixed(0)}%</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Trend:</small><br>
                                            <span class="trend-${pricePrediction.direction || 'stable'}">
                                                <i class="fas fa-${pricePrediction.direction === 'rising' ? 'arrow-up' : pricePrediction.direction === 'falling' ? 'arrow-down' : 'minus'}"></i>
                                                ${pricePrediction.direction || 'stable'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Buyee Price:</small><br>
                                        <strong>¥${result.price_yen}</strong><br>
                                        <small class="text-muted">($${result.price_usd})</small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">eBay Avg:</small><br>
                                        <strong class="${profitClass}">$${result.ebay_avg_price}</strong>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Profit:</small><br>
                                        <span class="${profitClass}">${result.profit_margin}%</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Smart Score:</small><br>
                                        <strong>${smartScore.toFixed(1)}/100</strong>
                                    </div>
                                </div>
                                
                                ${result.listing_url ? `
                                    <div class="mt-3">
                                        <a href="${result.listing_url}" target="_blank" class="btn btn-outline-primary btn-sm me-2" onclick="event.stopPropagation(); event.preventDefault(); window.open('${result.listing_url}', '_blank'); return false;">
                                            <i class="fas fa-external-link-alt me-1"></i>View on Buyee
                                        </a>
                                        ${result.yahoo_url ? `<a href="${result.yahoo_url}" target="_blank" class="btn btn-outline-warning btn-sm" onclick="event.stopPropagation(); event.preventDefault(); window.open('${result.yahoo_url}', '_blank'); return false;"><i class='fas fa-gavel me-1'></i>View on Yahoo Auctions</a>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        </a>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }
        
        function updateStats() {
            if (currentResults.length === 0) {
                document.getElementById('total-listings').textContent = '0';
                document.getElementById('profitable-listings').textContent = '0';
                document.getElementById('strong-buys').textContent = '0';
                document.getElementById('avg-smart-score').textContent = '0';
                return;
            }
            
            const profitable = currentResults.filter(r => r.profit_margin > 0).length;
            const strongBuys = currentResults.filter(r => r.recommended_action === 'STRONG BUY').length;
            const avgSmartScore = (currentResults.reduce((sum, r) => sum + (r.smart_score || r.arbitrage_score || 0), 0) / currentResults.length).toFixed(1);
            
            document.getElementById('total-listings').textContent = currentResults.length;
            document.getElementById('profitable-listings').textContent = profitable;
            document.getElementById('strong-buys').textContent = strongBuys;
            document.getElementById('avg-smart-score').textContent = avgSmartScore;
        }
        
        function applyFilters() {
            loadResults();
        }
        
        function clearFilters() {
            document.getElementById('minScore').value = '0';
            document.getElementById('maxPrice').value = '';
            document.getElementById('minProfit').value = '0';
            document.getElementById('actionFilter').value = '';
            document.getElementById('searchTermFilter').value = '';
            document.getElementById('conditionFilter').value = '';
            document.getElementById('rarityFilter').value = '';
            document.getElementById('riskFilter').value = '';
            loadResults();
        }
        
        function loadSearchTerms() {
            fetch('/api/search_terms')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('searchTermFilter');
                        select.innerHTML = '<option value="">All Terms</option>';
                        data.search_terms.forEach(term => {
                            select.innerHTML += `<option value="${term}">${term}</option>`;
                        });
                    }
                })
                .catch(error => console.error('Error loading search terms:', error));
        }
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadResults();
            loadSearchTerms();
        });
        
        // Auto-refresh every 30 seconds
        setInterval(loadResults, 30000);
    </script>
</body>
</html>
